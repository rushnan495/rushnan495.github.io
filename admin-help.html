<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDU SPORTS IT | Admin Inbox</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial}
body{height:100vh;background:#071027;color:#fff;display:flex;overflow:hidden}

/* SIDEBAR */
.sidebar{
  width:320px;background:#0f172a;border-right:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;
}
.top{padding:14px;font-weight:700;color:#38bdf8;border-bottom:1px solid rgba(255,255,255,.05)}
.user-list{flex:1;overflow-y:auto}
.user-item{display:flex;align-items:center;gap:12px;padding:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.04);}
.user-item:hover{background:rgba(56,189,248,.05)}
.user-item.active{background:rgba(56,189,248,.15);box-shadow:inset 3px 0 0 #38bdf8;animation:glow 1.5s infinite alternate;}
@keyframes glow{from{box-shadow:inset 3px 0 0 #38bdf8,0 0 8px rgba(56,189,248,.4);}to{box-shadow:inset 3px 0 0 #38bdf8,0 0 18px rgba(56,189,248,.7);}}
.user-item img{width:44px;height:44px;border-radius:50%}
.user-meta{flex:1;min-width:0}
.user-meta strong{display:block}
.user-meta span{font-size:13px;color:#cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dot{width:10px;height:10px;background:#2563eb;border-radius:50%;box-shadow:0 0 10px rgba(37,99,235,.9);}

/* CHAT */
.right{flex:1;display:flex;flex-direction:column}
.chat-header{padding:12px;display:flex;gap:12px;align-items:center;border-bottom:1px solid rgba(255,255,255,.05)}
.chat-header img{width:44px;height:44px;border-radius:50%}
.chat-body{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
.msg{max-width:75%;display:flex;gap:8px}
.msg.right{margin-left:auto;flex-direction:row-reverse}
.msg img{width:34px;height:34px;border-radius:50%}
.bubble{padding:10px 12px;border-radius:10px;font-size:14px}
.bubble.user{background:#38bdf8;color:#071027}
.bubble.admin{background:#ffd166;color:#000}

/* FOOTER */
.chat-footer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.05)}
.chat-footer input{flex:1;padding:10px;border-radius:8px;border:none;outline:none;}
.chat-footer button{padding:10px 14px;border:none;border-radius:8px;background:#38bdf8;font-weight:700;cursor:pointer}

/* MOBILE */
@media(max-width:768px){
  .sidebar{width:100%}
  .right{display:none}
  body.chat-open .sidebar{display:none}
  body.chat-open .right{display:flex}
}
</style>
</head>

<body>

<!-- LONGER NOTIFICATION SOUND -->
<audio id="notifSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2577/2577-preview.mp3" type="audio/mpeg">
</audio>

<div class="sidebar">
  <div class="top">Inbox</div>
  <div class="user-list" id="userList"></div>
</div>

<div class="right">
  <div class="chat-header">
    <img id="chatImg" src="edu-sports-it.png">
    <div>
      <div id="chatName" style="color:#38bdf8;font-weight:700">Select user</div>
      <div id="chatTime" style="font-size:12px;color:#9fb7c4"></div>
    </div>
  </div>

  <div class="chat-body" id="chatBody"></div>

  <div class="chat-footer">
    <input id="msgInput" placeholder="Type reply..." disabled>
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDR5yywOyYjCSnfTyLTcMUIz-hG80jZXU4",
  databaseURL:"https://edu-sports-it-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

const userList=document.getElementById("userList");
const chatBody=document.getElementById("chatBody");
const chatName=document.getElementById("chatName");
const chatImg=document.getElementById("chatImg");
const chatTime=document.getElementById("chatTime");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const sound=document.getElementById("notifSound");

let users={},active=null;

/* LOAD INBOX */
db.ref("inbox").on("value",snap=>{
  users=snap.val()||{};
  userList.innerHTML="";
  Object.values(users)
    .sort((a,b)=>(b.lastMessageAt||0)-(a.lastMessageAt||0))
    .forEach(u=>{
      const d=document.createElement("div");
      d.className="user-item"+(active===u.clientId?" active":"");
      d.innerHTML=`
        <img src="${u.userAvatar||'edu-sports-it.png'}">
        <div class="user-meta">
          <strong>${u.userName||u.clientId}</strong>
          <span>${u.lastMessage||""}</span>
        </div>
        ${u.unread?'<div class="dot"></div>':""}
      `;
      d.onclick=()=>openChat(u.clientId);
      userList.appendChild(d);
    });
});

/* NEW MESSAGE */
db.ref("messages").on("child_added",snap=>{
  const m=snap.val(); if(!m) return;
  const prev=users[m.clientId]?.unread||false;

  if(m.from==='user' && active!==m.clientId){
    sound.play().catch(()=>{});
    navigator.vibrate && navigator.vibrate([200,100,200]);
  }

  db.ref("inbox/"+m.clientId).update({
    clientId:m.clientId,
    userName:m.userName||m.clientId,
    userAvatar:m.userAvatar||'edu-sports-it.png',
    lastMessage:m.text,
    lastMessageAt:m.timestamp||Date.now(),
    unread:m.from==='user' && active!==m.clientId?true:prev
  });

  if(active===m.clientId){
    addMsg(m);
    db.ref("inbox/"+m.clientId).update({unread:false});
  }
});

/* OPEN CHAT */
function openChat(id){
  active=id;
  document.body.classList.add("chat-open");
  msgInput.disabled=false;
  sendBtn.disabled=false;
  msgInput.focus();

  const u=users[id];
  chatName.textContent=u.userName||id;
  chatImg.src=u.userAvatar||"edu-sports-it.png";
  chatTime.textContent=new Date(u.lastMessageAt||Date.now()).toLocaleString();

  db.ref("inbox/"+id).update({unread:false});
  chatBody.innerHTML="";
  db.ref("messages").orderByChild("clientId").equalTo(id).once("value",s=>{
    Object.values(s.val()||{}).sort((a,b)=>(a.timestamp||0)-(b.timestamp||0)).forEach(addMsg);
    chatBody.scrollTop=chatBody.scrollHeight;
  });
}

/* ADD MESSAGE */
function addMsg(m){
  const d=document.createElement("div");
  d.className="msg "+(m.from==="user"?"right":"");
  d.innerHTML=`
    <img src="${m.from==='admin'?'rushnan.jpg':(m.userAvatar||'edu-sports-it.png')}">
    <div class="bubble ${m.from}">
      ${m.from==='admin'?'Rushnan Khan: ':''}${m.text}
    </div>`;
  chatBody.appendChild(d);
  chatBody.scrollTop=chatBody.scrollHeight;
}

/* SEND */
sendBtn.onclick=()=>{
  if(!msgInput.value||!active)return;
  db.ref("messages").push({
    text:msgInput.value,
    from:"admin",
    clientId:active,
    timestamp:Date.now()
  });
  msgInput.value="";
};
</script>
</body>
</html>
